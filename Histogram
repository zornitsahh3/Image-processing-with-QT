#include <QApplication>
#include <QLabel>
#include <QImage>
#include <QPixmap>
#include <QTextStream>
#include <stdexcept>

// Constants
const int INTENS_MIN = 0;
const int INTENS_MAX = 255;

enum Color { RED, GREEN, BLUE };

const QString file_name = "barbie.jpg";

// Calculates normalized histogram for a color channel
void histogram(const QImage &image, double hst[], Color clr)
{
    // Initialize histogram
    for (int i = 0; i <= INTENS_MAX; i++)
        hst[i] = 0.0;

    // Count intensity occurrences
    for (int indx_row = 0; indx_row < image.height(); indx_row++)
    {
        const QRgb* ptr_row = reinterpret_cast<const QRgb*>(image.scanLine(indx_row));

        for (int indx_col = 0; indx_col < image.width(); indx_col++)
        {
            int bean = 0;
            switch (clr)
            {
                case RED:   bean = qRed(ptr_row[indx_col]); break;
                case GREEN: bean = qGreen(ptr_row[indx_col]); break;
                case BLUE:  bean = qBlue(ptr_row[indx_col]); break;
                default:    throw std::runtime_error("Unknown color code");
            }
            hst[bean]++;
        }
    }

    // Normalize histogram
    int nmb_pxl = image.height() * image.width();
    for (int i = 0; i <= INTENS_MAX; i++)
        hst[i] /= nmb_pxl;
}

// Prints histogram to console
void print(const double hst[])
{
    QTextStream out(stdout);
    for (int i = 0; i <= INTENS_MAX; i++)
        out << i << ": " << hst[i] << Qt::endl;
}

int main(int argc, char *argv[])
{
    QApplication app(argc, argv);

    QImage image;
    QLabel label;

    if (image.load(file_name))
    {
        QTextStream(stdout) << "Image loaded: " << file_name << Qt::endl;

        if (image.format() != QImage::Format_RGB32)
        {
            QTextStream(stdout) << "Converting format to Format_RGB32..." << Qt::endl;
            image = image.convertToFormat(QImage::Format_RGB32);
        }

        // Compute histograms
        double hR[256], hG[256], hB[256];

        histogram(image, hR, RED);
        histogram(image, hG, GREEN);
        histogram(image, hB, BLUE);

        QTextStream(stdout) << "\n--- RED HISTOGRAM ---\n";
        print(hR);

        QTextStream(stdout) << "\n--- GREEN HISTOGRAM ---\n";
        print(hG);

        QTextStream(stdout) << "\n--- BLUE HISTOGRAM ---\n";
        print(hB);

        // Display image
        label.setPixmap(QPixmap::fromImage(image));
        label.show();
    }
    else
    {
        QTextStream(stdout) << "Cannot load image: " << file_name << Qt::endl;
    }

    return app.exec();
}
